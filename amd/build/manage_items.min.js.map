{"version":3,"file":"manage_items.min.js","sources":["../src/manage_items.js"],"sourcesContent":["define(['jquery', 'core/notification', 'core/ajax', 'core/copy_to_clipboard'], function($, Notification, Ajax) {\n\n    /**\n     * Manage Items module for PlayerHUD.\n     *\n     * @module     block_playerhud/manage_items\n     * @copyright  2026 Jean LÃºcio\n     * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n     */\n    return {\n        /**\n         * Initialize the module.\n         *\n         * @param {Object} config The configuration object passed from PHP.\n         */\n        init: function(config) {\n\n            // Move modals to body to avoid z-index issues.\n            $('#phAiModal').appendTo('body');\n            $('#phItemModalView').appendTo('body');\n\n            // --- 1. BULK ACTIONS ---\n\n            // Select All Checkbox.\n            $('#ph-select-all').on('change', function() {\n                var isChecked = $(this).is(':checked');\n                $('.ph-bulk-check').prop('checked', isChecked).trigger('change');\n            });\n\n            // Update \"Delete Selected\" button state.\n            $('body').on('change', '.ph-bulk-check, #ph-select-all', function() {\n                var count = $('.ph-bulk-check:checked').length;\n                var $btn = $('#ph-btn-bulk-delete');\n\n                if (count > 0) {\n                    $btn.removeClass('disabled').removeAttr('disabled');\n                    var btnText = config.strings.delete_n_items.replace('%d', count);\n                    $btn.html('<i class=\"fa fa-trash\" aria-hidden=\"true\"></i> ' + btnText);\n                } else {\n                    $btn.addClass('disabled').attr('disabled', 'disabled');\n                    $btn.html('<i class=\"fa fa-trash\" aria-hidden=\"true\"></i> ' + config.strings.delete_selected);\n                }\n            });\n\n            // Confirm Bulk Delete.\n            $('#ph-btn-bulk-delete').on('click', function(e) {\n                e.preventDefault();\n                if ($('.ph-bulk-check:checked').length === 0) {\n                    return;\n                }\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    config.strings.confirm_bulk,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        $('#bulk-action-form').submit();\n                    }\n                );\n            });\n\n            // --- 2. PREVIEW MODAL ---\n\n            $('body').on('click', '.ph-preview-trigger', function(e) {\n                e.preventDefault();\n                var trigger = $(this);\n\n                // Extract data attributes.\n                var name = trigger.attr('data-name');\n                var xp = trigger.attr('data-xp');\n                var img = trigger.attr('data-image');\n                var isImg = trigger.attr('data-isimage'); // \"1\" or \"0\"\n                var descTarget = trigger.attr('data-desc-target');\n                var descHtml = descTarget ? $('#' + descTarget).html() : '';\n\n                // Populate Modal.\n                $('#phModalNameView, #phModalTitleView').text(name);\n                $('#phModalXPView').text(xp);\n\n                var $descEl = $('#phModalDescView');\n                if (descHtml && descHtml.trim() !== '') {\n                    $descEl.html(descHtml);\n                } else {\n                    $descEl.html('<i class=\"text-muted\">' + config.strings.no_desc + '</i>');\n                }\n\n                // Image Handling.\n                var $imgCont = $('#phModalImageContainerView');\n                $imgCont.empty();\n\n                if (isImg === '1') {\n                    $imgCont.append($('<img>', {\n                        src: img,\n                        'class': 'ph-modal-img',\n                        alt: ''\n                    }));\n                } else {\n                    $imgCont.append($('<span>', {\n                        'class': 'ph-modal-emoji',\n                        'aria-hidden': 'true',\n                        text: img\n                    }));\n                }\n\n                // Open Modal (Bootstrap 5 compatible).\n                var modalEl = document.getElementById('phItemModalView');\n                // eslint-disable-next-line no-undef\n                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {\n                    // eslint-disable-next-line no-undef\n                    bootstrap.Modal.getOrCreateInstance(modalEl).show();\n                } else {\n                    // Fallback for older themes.\n                    $(modalEl).modal('show');\n                }\n            });\n\n            // --- 3. AI GENERATION (EXTERNAL API) ---\n\n            // Toggle AI Drop Options visibility.\n            $('#ai-drop').on('change', function() {\n                var isChecked = $(this).is(':checked');\n                if (isChecked) {\n                    $('#ai-drop-options').slideDown();\n                } else {\n                    $('#ai-drop-options').slideUp();\n                }\n            });\n\n            // Single Item Delete Confirmation.\n            $('body').on('click', '.js-delete-btn', function(e) {\n                e.preventDefault();\n                var $btn = $(this);\n                var targetUrl = $btn.attr('href');\n                var msg = $btn.attr('data-confirm-msg');\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    msg,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        window.location.href = targetUrl;\n                    }\n                );\n            });\n\n            // Submit AI form on Enter key.\n            $('#ph-ai-form').on('submit', function(e) {\n                e.preventDefault();\n                $('#ph-btn-conjure').click();\n            });\n\n            // AI Logic using Core AJAX.\n            $('#ph-btn-conjure').on('click', function(e) {\n                e.preventDefault();\n                var $btn = $(this);\n\n                if ($btn.prop('disabled')) {\n                    return;\n                }\n\n                var theme = $('#ai-theme').val();\n                if (!theme) {\n                    Notification.alert('Error', config.strings.err_theme, 'OK');\n                    return;\n                }\n\n                var originalText = $btn.text();\n                $btn.prop('disabled', true).text(config.strings.ai_creating).attr('aria-busy', 'true');\n\n                // Call Moodle External Function.\n                // We disable camelcase rule here because PHP External API uses snake_case keys.\n                /* eslint-disable camelcase */\n                var request = {\n                    methodname: 'block_playerhud_generate_ai_content',\n                    args: {\n                        instanceid: config.instanceid,\n                        courseid: config.courseid,\n                        theme: theme,\n                        xp: parseInt($('#ai-xp').val()) || 0,\n                        amount: parseInt($('#ai-amount').val()) || 1,\n                        create_drop: $('#ai-drop').is(':checked'),\n                        drop_location: $('#ai-location').val() || '',\n                        drop_max: parseInt($('#ai-maxusage').val()) || 0,\n                        drop_time: parseInt($('#ai-respawn').val()) || 0\n                    }\n                };\n                /* eslint-enable camelcase */\n\n                Ajax.call([request])[0].done(function(resp) {\n                    $btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n\n                    if (resp.success) {\n                        // Reload page on modal close.\n                        $('#phAiModal').one('hidden.bs.modal', function() {\n                            window.location.reload();\n                        });\n\n                        var $modalTitle = $('#phAiModalLabel');\n                        $modalTitle.text(config.strings.success_title);\n\n                        var successHtml = '<div id=\"ph-success-container\" tabindex=\"-1\" ';\n                        successHtml += 'class=\"text-center py-3 ph-animate-fadein\" style=\"outline: none;\">';\n                        successHtml += '<div class=\"mb-3 ph-success-icon\" aria-hidden=\"true\">';\n                        successHtml += '<i class=\"fa fa-check-circle\"></i></div>';\n\n                        // Handle item list display.\n                        var items = resp.created_items || [];\n                        // Fallback if array is empty but single item name exists.\n                        if (items.length === 0 && resp.item_name) {\n                            items.push(resp.item_name);\n                        }\n                        var itemsList = items.join(', ');\n                        var count = items.length;\n\n                        successHtml += '<h2 class=\"fw-bold text-primary mb-3\">' + count + 'x Itens Criados!</h2>';\n                        successHtml += '<p class=\"text-muted\">' + itemsList + '</p>';\n\n                        // Warnings and Info messages.\n                        if (resp.warning_msg) {\n                            successHtml += '<div class=\"alert alert-warning small mb-3\">';\n                            successHtml += '<i class=\"fa fa-exclamation-triangle\" aria-hidden=\"true\"></i> ';\n                            successHtml += resp.warning_msg + '</div>';\n                        } else if (resp.info_msg) {\n                            successHtml += '<div class=\"alert alert-success small mb-3\">';\n                            successHtml += '<i class=\"fa fa-check-circle\" aria-hidden=\"true\"></i> ';\n                            successHtml += resp.info_msg + '</div>';\n                        }\n\n                        successHtml += '<p class=\"lead text-muted mb-4\">' + config.strings.success + '</p>';\n\n                        // If single drop created, show copyable code.\n                        if (resp.drop_code && count === 1) {\n                            var fullCode = '[PLAYERHUD_DROP code=' + resp.drop_code + ']';\n\n                            successHtml += '<div class=\"card bg-light border-0 p-3 mx-auto\" style=\"max-width: 90%;\">';\n                            successHtml += '<label class=\"small text-muted mb-2 fw-bold text-start w-100\" ';\n                            successHtml += 'for=\"ph-gen-code-input\">' + config.strings.copy + ':</label>';\n                            successHtml += '<div class=\"input-group\">';\n                            successHtml += '<input type=\"text\" class=\"form-control font-monospace text-center ph-code-input\" ';\n                            successHtml += 'value=\"' + fullCode + '\" id=\"ph-gen-code-input\" readonly>';\n                            // Use Moodle Core Copy API.\n                            successHtml += '<button class=\"btn btn-primary\" type=\"button\" ';\n                            successHtml += 'data-action=\"copytoclipboard\" data-clipboard-target=\"#ph-gen-code-input\">';\n                            successHtml += '<i class=\"fa fa-copy\" aria-hidden=\"true\"></i> ';\n                            successHtml += config.strings.copy + '</button>';\n                            successHtml += '</div></div>';\n                        }\n\n                        successHtml += '</div>';\n\n                        $('#phAiModal .modal-body').html(successHtml);\n\n                        var $btnReload = $('<button class=\"btn btn-success w-100 py-2 fw-bold\">' +\n                             config.strings.great + '</button>');\n                        $btnReload.on('click', function() {\n                            window.location.reload();\n                        });\n\n                        $('#phAiModal .modal-footer').empty().append($btnReload);\n\n                        // Accessibility focus.\n                        setTimeout(function() {\n                            $('#ph-success-container').focus();\n                        }, 200);\n\n                    } else {\n                        Notification.alert('Error', resp.message, 'OK');\n                    }\n                }).fail(function(ex) {\n                    $btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n                    Notification.exception(ex);\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","Notification","Ajax","init","config","appendTo","on","isChecked","this","is","prop","trigger","count","length","$btn","removeClass","removeAttr","btnText","strings","delete_n_items","replace","html","addClass","attr","delete_selected","e","preventDefault","confirm","confirm_title","confirm_bulk","yes","cancel","submit","name","xp","img","isImg","descTarget","descHtml","text","$descEl","trim","no_desc","$imgCont","empty","append","src","alt","modalEl","document","getElementById","bootstrap","Modal","getOrCreateInstance","show","modal","slideDown","slideUp","targetUrl","msg","window","location","href","click","theme","val","originalText","ai_creating","request","methodname","args","instanceid","courseid","parseInt","amount","create_drop","drop_location","drop_max","drop_time","call","done","resp","success","one","reload","success_title","successHtml","items","created_items","item_name","push","itemsList","join","warning_msg","info_msg","drop_code","fullCode","copy","$btnReload","great","setTimeout","focus","alert","message","fail","ex","exception","err_theme"],"mappings":"AAAAA,sCAAO,CAAC,SAAU,oBAAqB,YAAa,2BAA2B,SAASC,EAAGC,aAAcC;;;;;;;;MAS9F,CAMHC,KAAM,SAASC,QAGXJ,EAAE,cAAcK,SAAS,QACzBL,EAAE,oBAAoBK,SAAS,QAK/BL,EAAE,kBAAkBM,GAAG,UAAU,eACzBC,UAAYP,EAAEQ,MAAMC,GAAG,YAC3BT,EAAE,kBAAkBU,KAAK,UAAWH,WAAWI,QAAQ,aAI3DX,EAAE,QAAQM,GAAG,SAAU,kCAAkC,eACjDM,MAAQZ,EAAE,0BAA0Ba,OACpCC,KAAOd,EAAE,0BAETY,MAAQ,EAAG,CACXE,KAAKC,YAAY,YAAYC,WAAW,gBACpCC,QAAUb,OAAOc,QAAQC,eAAeC,QAAQ,KAAMR,OAC1DE,KAAKO,KAAK,kDAAoDJ,cAE9DH,KAAKQ,SAAS,YAAYC,KAAK,WAAY,YAC3CT,KAAKO,KAAK,kDAAoDjB,OAAOc,QAAQM,oBAKrFxB,EAAE,uBAAuBM,GAAG,SAAS,SAASmB,GAC1CA,EAAEC,iBACyC,IAAvC1B,EAAE,0BAA0Ba,QAIhCZ,aAAa0B,QACTvB,OAAOc,QAAQU,cACfxB,OAAOc,QAAQW,aACfzB,OAAOc,QAAQY,IACf1B,OAAOc,QAAQa,QACf,WACI/B,EAAE,qBAAqBgC,eAOnChC,EAAE,QAAQM,GAAG,QAAS,uBAAuB,SAASmB,GAClDA,EAAEC,qBACEf,QAAUX,EAAEQ,MAGZyB,KAAOtB,QAAQY,KAAK,aACpBW,GAAKvB,QAAQY,KAAK,WAClBY,IAAMxB,QAAQY,KAAK,cACnBa,MAAQzB,QAAQY,KAAK,gBACrBc,WAAa1B,QAAQY,KAAK,oBAC1Be,SAAWD,WAAarC,EAAE,IAAMqC,YAAYhB,OAAS,GAGzDrB,EAAE,uCAAuCuC,KAAKN,MAC9CjC,EAAE,kBAAkBuC,KAAKL,QAErBM,QAAUxC,EAAE,oBACZsC,UAAgC,KAApBA,SAASG,OACrBD,QAAQnB,KAAKiB,UAEbE,QAAQnB,KAAK,yBAA2BjB,OAAOc,QAAQwB,QAAU,YAIjEC,SAAW3C,EAAE,8BACjB2C,SAASC,QAEK,MAAVR,MACAO,SAASE,OAAO7C,EAAE,QAAS,CACvB8C,IAAKX,UACI,eACTY,IAAK,MAGTJ,SAASE,OAAO7C,EAAE,SAAU,OACf,+BACM,OACfuC,KAAMJ,WAKVa,QAAUC,SAASC,eAAe,mBAEb,oBAAdC,WAA6BA,UAAUC,MAE9CD,UAAUC,MAAMC,oBAAoBL,SAASM,OAG7CtD,EAAEgD,SAASO,MAAM,WAOzBvD,EAAE,YAAYM,GAAG,UAAU,WACPN,EAAEQ,MAAMC,GAAG,YAEvBT,EAAE,oBAAoBwD,YAEtBxD,EAAE,oBAAoByD,aAK9BzD,EAAE,QAAQM,GAAG,QAAS,kBAAkB,SAASmB,GAC7CA,EAAEC,qBACEZ,KAAOd,EAAEQ,MACTkD,UAAY5C,KAAKS,KAAK,QACtBoC,IAAM7C,KAAKS,KAAK,oBAEpBtB,aAAa0B,QACTvB,OAAOc,QAAQU,cACf+B,IACAvD,OAAOc,QAAQY,IACf1B,OAAOc,QAAQa,QACf,WACI6B,OAAOC,SAASC,KAAOJ,gBAMnC1D,EAAE,eAAeM,GAAG,UAAU,SAASmB,GACnCA,EAAEC,iBACF1B,EAAE,mBAAmB+D,WAIzB/D,EAAE,mBAAmBM,GAAG,SAAS,SAASmB,GACtCA,EAAEC,qBACEZ,KAAOd,EAAEQ,UAETM,KAAKJ,KAAK,iBAIVsD,MAAQhE,EAAE,aAAaiE,SACtBD,WAKDE,aAAepD,KAAKyB,OACxBzB,KAAKJ,KAAK,YAAY,GAAM6B,KAAKnC,OAAOc,QAAQiD,aAAa5C,KAAK,YAAa,YAK3E6C,QAAU,CACVC,WAAY,sCACZC,KAAM,CACFC,WAAYnE,OAAOmE,WACnBC,SAAUpE,OAAOoE,SACjBR,MAAOA,MACP9B,GAAIuC,SAASzE,EAAE,UAAUiE,QAAU,EACnCS,OAAQD,SAASzE,EAAE,cAAciE,QAAU,EAC3CU,YAAa3E,EAAE,YAAYS,GAAG,YAC9BmE,cAAe5E,EAAE,gBAAgBiE,OAAS,GAC1CY,SAAUJ,SAASzE,EAAE,gBAAgBiE,QAAU,EAC/Ca,UAAWL,SAASzE,EAAE,eAAeiE,QAAU,IAKvD/D,KAAK6E,KAAK,CAACX,UAAU,GAAGY,MAAK,SAASC,SAClCnE,KAAKJ,KAAK,YAAY,GAAO6B,KAAK2B,cAAclD,WAAW,aAEvDiE,KAAKC,QAAS,CAEdlF,EAAE,cAAcmF,IAAI,mBAAmB,WACnCvB,OAAOC,SAASuB,YAGFpF,EAAE,mBACRuC,KAAKnC,OAAOc,QAAQmE,mBAE5BC,YAAc,gDAClBA,aAAe,qEACfA,aAAe,wDACfA,aAAe,+CAGXC,MAAQN,KAAKO,eAAiB,GAEb,IAAjBD,MAAM1E,QAAgBoE,KAAKQ,WAC3BF,MAAMG,KAAKT,KAAKQ,eAEhBE,UAAYJ,MAAMK,KAAK,MACvBhF,MAAQ2E,MAAM1E,UAElByE,aAAe,yCAA2C1E,MAAQ,wBAClE0E,aAAe,yBAA2BK,UAAY,OAGlDV,KAAKY,aACLP,aAAe,+CACfA,aAAe,iEACfA,aAAeL,KAAKY,YAAc,UAC3BZ,KAAKa,WACZR,aAAe,+CACfA,aAAe,yDACfA,aAAeL,KAAKa,SAAW,UAGnCR,aAAe,mCAAqClF,OAAOc,QAAQgE,QAAU,OAGzED,KAAKc,WAAuB,IAAVnF,MAAa,KAC3BoF,SAAW,wBAA0Bf,KAAKc,UAAY,IAE1DT,aAAe,2EACfA,aAAe,iEACfA,aAAe,2BAA6BlF,OAAOc,QAAQ+E,KAAO,YAClEX,aAAe,4BACfA,aAAe,oFACfA,aAAe,UAAYU,SAAW,qCAEtCV,aAAe,iDACfA,aAAe,4EACfA,aAAe,iDACfA,aAAelF,OAAOc,QAAQ+E,KAAO,YACrCX,aAAe,eAGnBA,aAAe,SAEftF,EAAE,0BAA0BqB,KAAKiE,iBAE7BY,WAAalG,EAAE,sDACdI,OAAOc,QAAQiF,MAAQ,aAC5BD,WAAW5F,GAAG,SAAS,WACnBsD,OAAOC,SAASuB,YAGpBpF,EAAE,4BAA4B4C,QAAQC,OAAOqD,YAG7CE,YAAW,WACPpG,EAAE,yBAAyBqG,UAC5B,UAGHpG,aAAaqG,MAAM,QAASrB,KAAKsB,QAAS,SAE/CC,MAAK,SAASC,IACb3F,KAAKJ,KAAK,YAAY,GAAO6B,KAAK2B,cAAclD,WAAW,aAC3Df,aAAayG,UAAUD,YA5GvBxG,aAAaqG,MAAM,QAASlG,OAAOc,QAAQyF,UAAW"}