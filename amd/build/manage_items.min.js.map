{"version":3,"file":"manage_items.min.js","sources":["../src/manage_items.js"],"sourcesContent":["define(['jquery', 'core/notification', 'core/ajax', 'core/copy_to_clipboard'], function($, Notification, Ajax) {\n\n    /**\n     * Manage Items module for PlayerHUD.\n     *\n     * @module     block_playerhud/manage_items\n     * @copyright  2026 Jean Lúcio\n     * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n     */\n    return {\n        /**\n         * Initialize the module.\n         *\n         * @param {Object} config The configuration object passed from PHP.\n         */\n        init: function(config) {\n\n            // Move modals to body to avoid z-index issues.\n            // IDs atualizados para kebab-case conforme Stylelint\n            $('#ph-ai-modal').appendTo('body');\n            $('#ph-item-modal-view').appendTo('body');\n\n            // --- FIXED: Explicitly handle AI Modal opening to ensure it works even if moved ---\n            $('body').on('click', '#btn-open-ai-modal', function(e) {\n                e.preventDefault();\n                var modalEl = document.getElementById('ph-ai-modal'); // ID ATUALIZADO\n                if (modalEl) {\n                    // eslint-disable-next-line no-undef\n                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {\n                        // eslint-disable-next-line no-undef\n                        var modal = bootstrap.Modal.getOrCreateInstance(modalEl);\n                        modal.show();\n                    } else if ($(modalEl).modal) {\n                        $(modalEl).modal('show');\n                    }\n                }\n            });\n\n            // --- 1. BULK ACTIONS ---\n\n            // Select All Checkbox.\n            $('#ph-select-all').on('change', function() {\n                var isChecked = $(this).is(':checked');\n                $('.ph-bulk-check').prop('checked', isChecked).trigger('change');\n            });\n\n            // Update \"Delete Selected\" button state.\n            $('body').on('change', '.ph-bulk-check, #ph-select-all', function() {\n                var count = $('.ph-bulk-check:checked').length;\n                var $btn = $('#ph-btn-bulk-delete');\n\n                if (count > 0) {\n                    $btn.removeClass('disabled').removeAttr('disabled');\n                    var btnText = config.strings.delete_n_items.replace('%d', count);\n                    $btn.html('<i class=\"fa fa-trash\" aria-hidden=\"true\"></i> ' + btnText);\n                } else {\n                    $btn.addClass('disabled').attr('disabled', 'disabled');\n                    $btn.html('<i class=\"fa fa-trash\" aria-hidden=\"true\"></i> ' + config.strings.delete_selected);\n                }\n            });\n\n            // Confirm Bulk Delete.\n            $('#ph-btn-bulk-delete').on('click', function(e) {\n                e.preventDefault();\n                if ($('.ph-bulk-check:checked').length === 0) {\n                    return;\n                }\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    config.strings.confirm_bulk,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        $('#bulk-action-form').submit();\n                    }\n                );\n            });\n\n            // --- 2. PREVIEW MODAL ---\n\n            $('body').on('click', '.ph-preview-trigger', function(e) {\n                e.preventDefault();\n                var trigger = $(this);\n\n                // Extract data attributes.\n                var name = trigger.attr('data-name');\n                var xp = trigger.attr('data-xp');\n                var img = trigger.attr('data-image');\n                var isImg = trigger.attr('data-isimage'); // \"1\" or \"0\"\n                var descTarget = trigger.attr('data-desc-target');\n                var descHtml = descTarget ? $('#' + descTarget).html() : '';\n\n                // Populate Modal (Internal IDs kept as camelCase in Mustache, so we use them here)\n                $('#phModalNameView, #phModalTitleView').text(name);\n                $('#phModalXPView').text(xp);\n\n                var $descEl = $('#phModalDescView');\n                if (descHtml && descHtml.trim() !== '') {\n                    $descEl.html(descHtml);\n                } else {\n                    $descEl.html('<i class=\"text-muted\">' + config.strings.no_desc + '</i>');\n                }\n\n                // Image Handling.\n                var $imgCont = $('#phModalImageContainerView');\n                $imgCont.empty();\n\n                if (isImg === '1') {\n                    $imgCont.append($('<img>', {\n                        src: img,\n                        'class': 'ph-modal-img',\n                        alt: ''\n                    }));\n                } else {\n                    $imgCont.append($('<span>', {\n                        'class': 'ph-modal-emoji',\n                        'aria-hidden': 'true',\n                        text: img\n                    }));\n                }\n\n                // Open Modal (Bootstrap 5 compatible)\n                // CORREÇÃO: Usando o ID atualizado com hífen\n                var modalEl = document.getElementById('ph-item-modal-view');\n\n                // eslint-disable-next-line no-undef\n                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {\n                    // eslint-disable-next-line no-undef\n                    bootstrap.Modal.getOrCreateInstance(modalEl).show();\n                } else {\n                    // Fallback for older themes.\n                    $(modalEl).modal('show');\n                }\n            });\n\n            // --- 3. AI GENERATION (EXTERNAL API) ---\n\n            // Toggle AI Drop Options visibility.\n            $('#ai-drop').on('change', function() {\n                var isChecked = $(this).is(':checked');\n                if (isChecked) {\n                    $('#ai-drop-options').slideDown();\n                } else {\n                    $('#ai-drop-options').slideUp();\n                }\n            });\n\n            // Single Item Delete Confirmation.\n            $('body').on('click', '.js-delete-btn', function(e) {\n                e.preventDefault();\n                var $btn = $(this);\n                var targetUrl = $btn.attr('href');\n                var msg = $btn.attr('data-confirm-msg');\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    msg,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        window.location.href = targetUrl;\n                    }\n                );\n            });\n\n            // Submit AI form on Enter key.\n            $('#ph-ai-form').on('submit', function(e) {\n                e.preventDefault();\n                $('#ph-btn-conjure').click();\n            });\n\n            // AI Logic using Core AJAX.\n            $('#ph-btn-conjure').on('click', function(e) {\n                e.preventDefault();\n                var $btn = $(this);\n\n                if ($btn.prop('disabled')) {\n                    return;\n                }\n\n                var theme = $('#ai-theme').val();\n                if (!theme) {\n                    Notification.alert('Error', config.strings.err_theme, 'OK');\n                    return;\n                }\n\n                var originalText = $btn.text();\n                $btn.prop('disabled', true).text(config.strings.ai_creating).attr('aria-busy', 'true');\n\n                // Call Moodle External Function.\n                /* eslint-disable camelcase */\n                var request = {\n                    methodname: 'block_playerhud_generate_ai_content',\n                    args: {\n                        instanceid: config.instanceid,\n                        courseid: config.courseid,\n                        theme: theme,\n                        xp: parseInt($('#ai-xp').val()) || 0,\n                        amount: parseInt($('#ai-amount').val()) || 1,\n                        create_drop: $('#ai-drop').is(':checked'),\n                        drop_location: $('#ai-location').val() || '',\n                        drop_max: parseInt($('#ai-maxusage').val()) || 0,\n                        drop_time: parseInt($('#ai-respawn').val()) || 0\n                    }\n                };\n                /* eslint-enable camelcase */\n\n                Ajax.call([request])[0].done(function(resp) {\n                    $btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n\n                    if (resp.success) {\n                        // Reload page on modal close.\n                        // CORREÇÃO: ID atualizado\n                        $('#ph-ai-modal').one('hidden.bs.modal', function() {\n                            window.location.reload();\n                        });\n\n                        var $modalTitle = $('#phAiModalLabel');\n                        $modalTitle.text(config.strings.success_title);\n\n                        // Container Principal\n                        var successHtml = '<div id=\"ph-success-container\" tabindex=\"-1\" ';\n                        successHtml += 'class=\"text-center py-3 ph-animate-fadein\" style=\"outline: none;\">';\n\n                        // Ícone de Sucesso Animado\n                        successHtml += '<div class=\"mb-3 text-success\" style=\"font-size: 3rem;\" aria-hidden=\"true\">';\n                        successHtml += '<i class=\"fa fa-check-circle\"></i></div>';\n\n                        // Handle item list display.\n                        var items = resp.created_items || [];\n                        if (items.length === 0 && resp.item_name) {\n                            items.push(resp.item_name);\n                        }\n                        var itemsList = items.join(', ');\n                        var count = items.length;\n\n                        // TÍTULO\n                        var titleText = config.strings.created_count.replace('{$a}', count);\n                        successHtml += '<h5 class=\"text-muted text-uppercase small fw-bold mb-2\">' + titleText + '</h5>';\n\n                        // DESTAQUE\n                        successHtml += '<h2 class=\"fw-bold text-dark mb-4 display-6\">' + itemsList + '</h2>';\n\n                        // Warnings and Info messages\n                        if (resp.warning_msg) {\n                            successHtml += '<div class=\"alert alert-warning small mb-3 text-start\">';\n                            successHtml += '<i class=\"fa fa-exclamation-triangle me-2\" aria-hidden=\"true\"></i> ';\n                            successHtml += resp.warning_msg + '</div>';\n                        } else if (resp.info_msg) {\n                            // eslint-disable-next-line max-len\n                            successHtml += '<div class=\"alert alert-success small mb-3 text-start border-success bg-success-subtle text-success-emphasis\">';\n                            successHtml += '<i class=\"fa fa-info-circle me-2\" aria-hidden=\"true\"></i> ';\n                            successHtml += resp.info_msg + '</div>';\n                        }\n\n                        // Drop Code\n                        if (resp.drop_code && count === 1) {\n                            var fullCode = '[PLAYERHUD_DROP code=' + resp.drop_code + ']';\n\n                            successHtml += '<div class=\"card bg-light border-0 p-3 mx-auto mt-4\" style=\"max-width: 90%;\">';\n                            successHtml += '<label class=\"small text-muted mb-1 fw-bold text-start w-100\" ';\n                            successHtml += 'for=\"ph-gen-code-input\">' + config.strings.copy + ':</label>';\n                            successHtml += '<div class=\"input-group\">';\n                            successHtml += '<input type=\"text\" class=\"form-control font-monospace text-center ph-code-input\" ';\n                            successHtml += 'value=\"' + fullCode + '\" id=\"ph-gen-code-input\" readonly>';\n                            successHtml += '<button class=\"btn btn-primary\" type=\"button\" ';\n                            successHtml += 'data-action=\"copytoclipboard\" data-clipboard-target=\"#ph-gen-code-input\">';\n                            successHtml += '<i class=\"fa fa-copy\" aria-hidden=\"true\"></i> ';\n                            successHtml += config.strings.copy + '</button>';\n                            successHtml += '</div></div>';\n                        }\n\n                        successHtml += '</div>';\n\n                        // CORREÇÃO: IDs atualizados\n                        $('#ph-ai-modal .modal-body').html(successHtml);\n\n                        // Botão de Fechar/Recarregar\n                        var $btnReload = $('<button class=\"btn btn-success w-100 py-2 fw-bold\">' +\n                             config.strings.great + '</button>');\n                        $btnReload.on('click', function() {\n                            window.location.reload();\n                        });\n\n                        $('#ph-ai-modal .modal-footer').empty().append($btnReload);\n\n                        // Accessibility focus.\n                        setTimeout(function() {\n                            $('#ph-success-container').focus();\n                        }, 200);\n\n                    } else {\n                        Notification.alert('Error', resp.message, 'OK');\n                    }\n                }).fail(function(ex) {\n                    $btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n                    Notification.exception(ex);\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","Notification","Ajax","init","config","appendTo","on","e","preventDefault","modalEl","document","getElementById","bootstrap","Modal","getOrCreateInstance","show","modal","isChecked","this","is","prop","trigger","count","length","$btn","removeClass","removeAttr","btnText","strings","delete_n_items","replace","html","addClass","attr","delete_selected","confirm","confirm_title","confirm_bulk","yes","cancel","submit","name","xp","img","isImg","descTarget","descHtml","text","$descEl","trim","no_desc","$imgCont","empty","append","src","alt","slideDown","slideUp","targetUrl","msg","window","location","href","click","theme","val","originalText","ai_creating","request","methodname","args","instanceid","courseid","parseInt","amount","create_drop","drop_location","drop_max","drop_time","call","done","resp","success","one","reload","success_title","successHtml","items","created_items","item_name","push","itemsList","join","created_count","warning_msg","info_msg","drop_code","fullCode","copy","$btnReload","great","setTimeout","focus","alert","message","fail","ex","exception","err_theme"],"mappings":"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"}