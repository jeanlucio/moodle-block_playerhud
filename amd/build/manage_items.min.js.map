{"version":3,"file":"manage_items.min.js","sources":["../src/manage_items.js"],"sourcesContent":["// eslint-disable-next-line no-redeclare\n/* global bootstrap, M */\ndefine(['jquery', 'core/notification'], function($, Notification) {\n\n    /**\n     * Manage Items module.\n     *\n     * @module     block_playerhud/manage_items\n     * @copyright  2026 Jean Lúcio\n     * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n     */\n    return {\n        /**\n         * Initialize the module.\n         *\n         * @param {Object} config The configuration object passed from PHP.\n         */\n        init: function(config) {\n\n            // Move modais para o body para evitar problemas de z-index/overflow\n            $('#phAiModal').appendTo('body');\n            $('#phItemModalView').appendTo('body');\n\n            // --- 1. LÓGICA DE AÇÕES EM MASSA (Bulk Actions) ---\n\n            // \"Selecionar Todos\"\n            $('#ph-select-all').on('change', function() {\n                var isChecked = $(this).is(':checked');\n                $('.ph-bulk-check').prop('checked', isChecked).trigger('change');\n            });\n\n            // Atualiza estado do botão \"Excluir Selecionados\"\n            $('body').on('change', '.ph-bulk-check, #ph-select-all', function() {\n                var count = $('.ph-bulk-check:checked').length;\n                var btn = $('#ph-btn-bulk-delete');\n\n                if (count > 0) {\n                    btn.removeClass('disabled').removeAttr('disabled');\n                    // Substitui o placeholder %d pelo número\n                    var btnText = config.strings.delete_n_items.replace('%d', count);\n                    btn.html('<i class=\"fa fa-trash\"></i> ' + btnText);\n                } else {\n                    btn.addClass('disabled').attr('disabled', 'disabled');\n                    btn.html('<i class=\"fa fa-trash\"></i> ' + config.strings.delete_selected);\n                }\n            });\n\n            // Confirmação de Exclusão em Massa\n            $('#ph-btn-bulk-delete').on('click', function(e) {\n                e.preventDefault();\n                var count = $('.ph-bulk-check:checked').length;\n\n                if (count === 0) {\n                    return;\n                }\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    config.strings.confirm_bulk,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        $('#bulk-action-form').submit();\n                    }\n                );\n            });\n\n            // --- 2. LÓGICA DE VISUALIZAÇÃO (Preview Modal) ---\n\n            $('body').on('click', '.ph-preview-trigger', function(e) {\n                e.preventDefault();\n                var trigger = $(this);\n\n                // Extrair dados\n                var name = trigger.attr('data-name');\n                var xp = trigger.attr('data-xp');\n                var img = trigger.attr('data-image');\n                var isImg = trigger.attr('data-isimage'); // \"1\" ou \"0\"\n\n                // Descrição (buscada de div oculta para segurança HTML)\n                var descTarget = trigger.attr('data-desc-target');\n                var descHtml = '';\n                if (descTarget) {\n                    descHtml = $('#' + descTarget).html();\n                }\n\n                // Povoar Modal\n                $('#phModalNameView, #phModalTitleView').text(name);\n                $('#phModalXPView').text(xp);\n\n                var descEl = $('#phModalDescView');\n                if (descHtml && descHtml.trim() !== '') {\n                    descEl.html(descHtml);\n                } else {\n                    descEl.html('<i class=\"text-muted\">' + config.strings.no_desc + '</i>');\n                }\n\n                // Imagem / Emoji\n                var imgCont = $('#phModalImageContainerView');\n                imgCont.empty();\n\n                if (isImg === '1') {\n                    imgCont.append($('<img>', {\n                        src: img,\n                        'class': 'ph-modal-img',\n                        alt: '',\n                        style: 'max-width:100px; max-height:100px; object-fit:contain;'\n                    }));\n                } else {\n                    imgCont.append($('<span>', {\n                        'class': 'ph-modal-emoji',\n                        'aria-hidden': 'true',\n                        style: 'font-size:60px; line-height:1;',\n                        text: img\n                    }));\n                }\n\n                // Abrir Modal (Compatibilidade BS5)\n                var modalEl = document.getElementById('phItemModalView');\n                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {\n                    bootstrap.Modal.getOrCreateInstance(modalEl).show();\n                } else {\n                    $(modalEl).modal('show');\n                }\n            });\n\n            // --- 3. LÓGICA EXISTENTE (Delete Único e IA) ---\n\n            // Toggle Opções Drop (IA)\n            $('#ai-drop').on('change', function() {\n                if ($(this).is(':checked')) {\n                    $('#ai-drop-options').slideDown();\n                } else {\n                    $('#ai-drop-options').slideUp();\n                }\n            });\n\n            // Confirmação de Delete Único\n            $('body').on('click', '.js-delete-btn', function(e) {\n                e.preventDefault();\n                var btn = $(this);\n                var targetUrl = btn.attr('href');\n                var msg = btn.attr('data-confirm-msg');\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    msg,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        window.location.href = targetUrl;\n                    }\n                );\n            });\n\n            // Submissão do Form IA via Enter\n            $('#ph-ai-form').on('submit', function(e) {\n                e.preventDefault();\n                $('#ph-btn-conjure').click();\n            });\n\n            // Lógica AJAX da IA\n            $('#ph-btn-conjure').on('click', function(e) {\n                e.preventDefault();\n                var btn = $(this);\n\n                if (btn.prop('disabled')) {\n                    return;\n                }\n\n                var theme = $('#ai-theme').val();\n                var xp = $('#ai-xp').val();\n                var amount = $('#ai-amount').val() || 1;\n                var createDrop = $('#ai-drop').is(':checked');\n\n                var locName = $('#ai-location').val();\n                var maxUsage = $('#ai-maxusage').val();\n                var respawn = $('#ai-respawn').val();\n\n                if (!theme) {\n                    Notification.alert('Error', config.strings.err_theme, 'OK');\n                    return;\n                }\n\n                var originalText = btn.text();\n                btn.prop('disabled', true).text(config.strings.ai_creating);\n                btn.attr('aria-busy', 'true');\n\n                $.ajax({\n                    url: M.cfg.wwwroot + '/blocks/playerhud/ajax_ai.php',\n                    method: 'POST',\n                    dataType: 'json',\n                    data: {\n                        instanceid: config.instanceid,\n                        id: config.courseid,\n                        theme: theme,\n                        xp: xp ? xp : 0,\n                        amount: amount,\n                        // eslint-disable-next-line camelcase\n                        create_drop: createDrop ? 1 : 0,\n                        // eslint-disable-next-line camelcase\n                        drop_location: locName,\n                        // eslint-disable-next-line camelcase\n                        drop_max: maxUsage,\n                        // eslint-disable-next-line camelcase\n                        drop_time: respawn,\n                        sesskey: M.cfg.sesskey\n                    },\n                    success: function(resp) {\n                        btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n\n                        if (resp.success) {\n                            var modalBody = $('#phAiModal .modal-body');\n                            var modalFooter = $('#phAiModal .modal-footer');\n                            var modalTitle = $('#phAiModalLabel');\n\n                            // Recarregar ao fechar\n                            $('#phAiModal').one('hidden.bs.modal', function() {\n                                window.location.reload();\n                            });\n\n                            // Layout Sucesso\n                            modalTitle.text(config.strings.success_title);\n\n                            var successHtml = '<div id=\"ph-success-container\" tabindex=\"-1\" ' +\n                                'class=\"text-center py-3 animate__animated animate__fadeIn\" style=\"outline: none;\">';\n\n                            successHtml += '<div class=\"mb-3\" style=\"font-size: 3rem; color: #28a745;\" aria-hidden=\"true\">' +\n                                '<i class=\"fa fa-check-circle\"></i></div>';\n\n                            var itemsList = Array.isArray(resp.created_items) ? resp.created_items.join(', ') : resp.item_name;\n                            var count = Array.isArray(resp.created_items) ? resp.created_items.length : 1;\n\n                            successHtml += '<h2 class=\"fw-bold text-primary mb-3\">' + count + 'x Itens Criados!</h2>';\n                            successHtml += '<p class=\"text-muted\">' + itemsList + '</p>';\n\n                            if (resp.warning_msg) {\n                                successHtml += '<div class=\"alert alert-warning small mb-3\">' +\n                                    '<i class=\"fa fa-exclamation-triangle\"></i> ' + resp.warning_msg + '</div>';\n                            } else if (resp.info_msg) {\n                                successHtml += '<div class=\"alert alert-success small mb-3\">' +\n                                    '<i class=\"fa fa-check-circle\"></i> ' + resp.info_msg + '</div>';\n                            }\n\n                            successHtml += '<p class=\"lead text-muted mb-4\">' + config.strings.success + '</p>';\n\n                            // Se criou apenas 1 drop, mostra o código para copiar\n                            if (count === 1 && resp.drop_code) {\n                                var fullShortcode = '[PLAYERHUD_DROP code=' + resp.drop_code + ']';\n\n                                successHtml += '<div class=\"card bg-light border-0 p-3 mx-auto\" style=\"max-width: 90%;\">';\n                                successHtml += '<label class=\"small text-muted mb-2 fw-bold text-start w-100\" ' +\n                                    'for=\"ph-gen-code-input\">' + config.strings.copy + ':</label>';\n\n                                successHtml += '<div class=\"input-group\">';\n                                successHtml += '<input type=\"text\" class=\"form-control font-monospace text-center\" ' +\n                                    'value=\"' + fullShortcode + '\" id=\"ph-gen-code-input\" readonly>';\n                                // eslint-disable-next-line max-len\n                                successHtml += '<button class=\"btn btn-primary\" type=\"button\" id=\"ph-btn-copy-code\" aria-label=\"' + config.strings.copy + '\">' +\n                                    '<i class=\"fa fa-copy\" aria-hidden=\"true\"></i></button>';\n                                successHtml += '</div></div>';\n                            } else if (count > 1 && createDrop) {\n                                successHtml += '<div class=\"alert alert-info\">Os drops foram criados. ' +\n                                    'Use o botão \"Gerar Código\" na lista para pegar cada um.</div>';\n                            }\n\n                            successHtml += '</div>';\n\n                            modalBody.html(successHtml);\n\n                            var btnReload = $('<button class=\"btn btn-success w-100 py-2 fw-bold\">' +\n                                config.strings.great + '</button>');\n\n                            btnReload.on('click', function() {\n                                window.location.reload();\n                            });\n\n                            modalFooter.empty().append(btnReload);\n\n                            if (count === 1 && resp.drop_code) {\n                                setTimeout(function() {\n                                    $('#ph-btn-copy-code').on('click', function() {\n                                        var copyText = document.getElementById(\"ph-gen-code-input\");\n                                        copyText.select();\n                                        copyText.setSelectionRange(0, 99999);\n                                        document.execCommand(\"copy\");\n\n                                        var $btn = $(this);\n                                        var originalIcon = '<i class=\"fa fa-copy\" aria-hidden=\"true\"></i>';\n                                        $btn.removeClass('btn-primary').addClass('btn-success')\n                                            .html('<i class=\"fa fa-check\" aria-hidden=\"true\"></i>');\n                                        setTimeout(function() {\n                                            $btn.removeClass('btn-success').addClass('btn-primary').html(originalIcon);\n                                        }, 2000);\n                                    });\n                                    $('#ph-success-container').focus();\n                                }, 200);\n                            }\n\n                        } else {\n                            Notification.alert('Error', resp.message, 'OK');\n                        }\n                    },\n                    error: function(xhr, status, error) {\n                        btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n                        var errorMsg = error;\n                        if (xhr.responseJSON && xhr.responseJSON.message) {\n                            errorMsg = xhr.responseJSON.message;\n                        } else if (xhr.responseText) {\n                            try {\n                                var r = JSON.parse(xhr.responseText);\n                                if (r.message) {\n                                    errorMsg = r.message;\n                                }\n                            } catch (e) {\n                                /* Empty */\n                            }\n                        }\n                        Notification.alert('Ops!', errorMsg, 'OK');\n                    }\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","Notification","init","config","appendTo","on","isChecked","this","is","prop","trigger","count","length","btn","removeClass","removeAttr","btnText","strings","delete_n_items","replace","html","addClass","attr","delete_selected","e","preventDefault","confirm","confirm_title","confirm_bulk","yes","cancel","submit","name","xp","img","isImg","descTarget","descHtml","text","descEl","trim","no_desc","imgCont","empty","append","src","alt","style","modalEl","document","getElementById","bootstrap","Modal","getOrCreateInstance","show","modal","slideDown","slideUp","targetUrl","msg","window","location","href","click","theme","val","amount","createDrop","locName","maxUsage","respawn","originalText","ai_creating","ajax","url","M","cfg","wwwroot","method","dataType","data","instanceid","id","courseid","create_drop","drop_location","drop_max","drop_time","sesskey","success","resp","modalBody","modalFooter","modalTitle","one","reload","success_title","successHtml","itemsList","Array","isArray","created_items","join","item_name","warning_msg","info_msg","drop_code","fullShortcode","copy","btnReload","great","setTimeout","copyText","select","setSelectionRange","execCommand","$btn","focus","alert","message","error","xhr","status","errorMsg","responseJSON","responseText","r","JSON","parse","err_theme"],"mappings":"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"}