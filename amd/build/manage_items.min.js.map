{"version":3,"file":"manage_items.min.js","sources":["../src/manage_items.js"],"sourcesContent":["/* global bootstrap */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\ndefine(['jquery', 'core/notification', 'core/ajax', 'core/copy_to_clipboard'], function($, Notification, Ajax) {\n\n    /**\n     * Manage Items module for PlayerHUD.\n     *\n     * @module     block_playerhud/manage_items\n     * @copyright  2026 Jean LÃºcio\n     * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n     */\n    return {\n        /**\n         * Initialize the module.\n         *\n         * @param {Object} config The configuration object passed from PHP.\n         */\n        init: function(config) {\n\n            // Move modals to body to avoid z-index issues.\n            // IDs updated to kebab-case per Stylelint.\n            $('#ph-ai-modal').appendTo('body');\n            $('#ph-item-modal-view').appendTo('body');\n\n            // Explicitly handle AI Modal opening to ensure it works even if moved.\n            $('body').on('click', '#btn-open-ai-modal', function(e) {\n                e.preventDefault();\n                const modalEl = document.getElementById('ph-ai-modal');\n                if (modalEl) {\n                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {\n                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);\n                        modal.show();\n                    } else if ($(modalEl).modal) {\n                        $(modalEl).modal('show');\n                    }\n                }\n            });\n\n            // --- 1. BULK ACTIONS ---\n\n            // Select All Checkbox.\n            $('#ph-select-all').on('change', function() {\n                const isChecked = $(this).is(':checked');\n                $('.ph-bulk-check').prop('checked', isChecked).trigger('change');\n            });\n\n            // Update \"Delete Selected\" button state.\n            $('body').on('change', '.ph-bulk-check, #ph-select-all', function() {\n                const count = $('.ph-bulk-check:checked').length;\n                const $btn = $('#ph-btn-bulk-delete');\n\n                if (count > 0) {\n                    $btn.removeClass('disabled').removeAttr('disabled');\n                    const btnText = config.strings.delete_n_items.replace('%d', count);\n                    $btn.html('<i class=\"fa fa-trash\" aria-hidden=\"true\"></i> ' + btnText);\n                } else {\n                    $btn.addClass('disabled').attr('disabled', 'disabled');\n                    $btn.html('<i class=\"fa fa-trash\" aria-hidden=\"true\"></i> ' + config.strings.delete_selected);\n                }\n            });\n\n            // Confirm Bulk Delete.\n            $('#ph-btn-bulk-delete').on('click', function(e) {\n                e.preventDefault();\n                if ($('.ph-bulk-check:checked').length === 0) {\n                    return;\n                }\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    config.strings.confirm_bulk,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        $('#bulk-action-form').submit();\n                    }\n                );\n            });\n\n            // --- 2. PREVIEW MODAL ---\n\n            $('body').on('click', '.ph-preview-trigger', function(e) {\n                e.preventDefault();\n                const trigger = $(this);\n\n                // Extract data attributes.\n                const name = trigger.attr('data-name');\n                const xp = trigger.attr('data-xp');\n                const img = trigger.attr('data-image');\n                const isImg = trigger.attr('data-isimage'); // \"1\" or \"0\"\n                const descTarget = trigger.attr('data-desc-target');\n                const descHtml = descTarget ? $('#' + descTarget).html() : '';\n\n                // Populate Modal.\n                $('#phModalNameView, #phModalTitleView').text(name);\n                $('#phModalXPView').text(xp);\n\n                const $descEl = $('#phModalDescView');\n                if (descHtml && descHtml.trim() !== '') {\n                    $descEl.html(descHtml);\n                } else {\n                    $descEl.html('<i class=\"text-muted\">' + config.strings.no_desc + '</i>');\n                }\n\n                // Image Handling.\n                const $imgCont = $('#phModalImageContainerView');\n                $imgCont.empty();\n\n                if (isImg === '1') {\n                    $imgCont.append($('<img>', {\n                        src: img,\n                        'class': 'ph-modal-img',\n                        alt: ''\n                    }));\n                } else {\n                    $imgCont.append($('<span>', {\n                        'class': 'ph-modal-emoji',\n                        'aria-hidden': 'true',\n                        text: img\n                    }));\n                }\n\n                // Open Modal (Bootstrap 5 compatible).\n                const modalEl = document.getElementById('ph-item-modal-view');\n\n                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {\n                    bootstrap.Modal.getOrCreateInstance(modalEl).show();\n                } else {\n                    // Fallback for older themes.\n                    $(modalEl).modal('show');\n                }\n            });\n\n            // --- 3. AI GENERATION (EXTERNAL API) ---\n\n            // Toggle AI Drop Options visibility.\n            $('#ai-drop').on('change', function() {\n                const isChecked = $(this).is(':checked');\n                if (isChecked) {\n                    $('#ai-drop-options').slideDown();\n                } else {\n                    $('#ai-drop-options').slideUp();\n                }\n            });\n\n            // Single Item Delete Confirmation.\n            $('body').on('click', '.js-delete-btn', function(e) {\n                e.preventDefault();\n                const $btn = $(this);\n                const targetUrl = $btn.attr('href');\n                const msg = $btn.attr('data-confirm-msg');\n\n                Notification.confirm(\n                    config.strings.confirm_title,\n                    msg,\n                    config.strings.yes,\n                    config.strings.cancel,\n                    function() {\n                        window.location.href = targetUrl;\n                    }\n                );\n            });\n\n            // Submit AI form on Enter key.\n            $('#ph-ai-form').on('submit', function(e) {\n                e.preventDefault();\n                $('#ph-btn-conjure').click();\n            });\n\n            // AI Logic using Core AJAX.\n            $('#ph-btn-conjure').on('click', function(e) {\n                e.preventDefault();\n                const $btn = $(this);\n\n                if ($btn.prop('disabled')) {\n                    return;\n                }\n\n                const theme = $('#ai-theme').val();\n                if (!theme) {\n                    Notification.alert('Error', config.strings.err_theme, 'OK');\n                    return;\n                }\n\n                const originalText = $btn.text();\n                $btn.prop('disabled', true).text(config.strings.ai_creating).attr('aria-busy', 'true');\n\n                // Call Moodle External Function.\n                const requestArgs = {\n                    instanceid: config.instanceid,\n                    courseid: config.courseid,\n                    theme: theme,\n                    xp: parseInt($('#ai-xp').val()) || 0,\n                    amount: parseInt($('#ai-amount').val()) || 1,\n                    // eslint-disable-next-line camelcase\n                    create_drop: $('#ai-drop').is(':checked'),\n                    // eslint-disable-next-line camelcase\n                    drop_location: $('#ai-location').val() || '',\n                    // eslint-disable-next-line camelcase\n                    drop_max: parseInt($('#ai-maxusage').val()) || 0,\n                    // eslint-disable-next-line camelcase\n                    drop_time: parseInt($('#ai-respawn').val()) || 0\n                };\n\n                const request = {\n                    methodname: 'block_playerhud_generate_ai_content',\n                    args: requestArgs\n                };\n\n                Ajax.call([request])[0].done(function(resp) {\n                    $btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n\n                    if (resp.success) {\n                        // Reload page on modal close.\n                        $('#ph-ai-modal').one('hidden.bs.modal', function() {\n                            window.location.reload();\n                        });\n\n                        const $modalTitle = $('#phAiModalLabel');\n                        $modalTitle.text(config.strings.success_title);\n\n                        // Main Container.\n                        let successHtml = '<div id=\"ph-success-container\" tabindex=\"-1\" ';\n                        successHtml += 'class=\"text-center py-3 ph-animate-fadein\" style=\"outline: none;\">';\n\n                        // Success Icon.\n                        successHtml += '<div class=\"mb-3 text-success\" style=\"font-size: 3rem;\" aria-hidden=\"true\">';\n                        successHtml += '<i class=\"fa fa-check-circle\"></i></div>';\n\n                        // Handle item list display.\n                        const items = resp.created_items || [];\n                        if (items.length === 0 && resp.item_name) {\n                            items.push(resp.item_name);\n                        }\n                        const itemsList = items.join(', ');\n                        const count = items.length;\n\n                        // Title.\n                        const titleText = config.strings.created_count.replace('{$a}', count);\n                        successHtml += '<h5 class=\"text-muted text-uppercase small fw-bold mb-2\">' + titleText + '</h5>';\n\n                        // Highlight.\n                        successHtml += '<h2 class=\"fw-bold text-dark mb-4 display-6\">' + itemsList + '</h2>';\n\n                        // Warnings and Info messages.\n                        if (resp.warning_msg) {\n                            successHtml += '<div class=\"alert alert-warning small mb-3 text-start\">';\n                            successHtml += '<i class=\"fa fa-exclamation-triangle me-2\" aria-hidden=\"true\"></i> ';\n                            successHtml += resp.warning_msg + '</div>';\n                        } else if (resp.info_msg) {\n                            successHtml += '<div class=\"alert alert-success small mb-3 text-start ' +\n                                'border-success bg-success-subtle text-success-emphasis\">';\n                            successHtml += '<i class=\"fa fa-info-circle me-2\" aria-hidden=\"true\"></i> ';\n                            successHtml += resp.info_msg + '</div>';\n                        }\n\n                        // Drop Code.\n                        if (resp.drop_code && count === 1) {\n                            const fullCode = '[PLAYERHUD_DROP code=' + resp.drop_code + ']';\n\n                            successHtml += '<div class=\"card bg-light border-0 p-3 mx-auto mt-4\" style=\"max-width: 90%;\">';\n                            successHtml += '<label class=\"small text-muted mb-1 fw-bold text-start w-100\" ';\n                            successHtml += 'for=\"ph-gen-code-input\">' + config.strings.copy + ':</label>';\n                            successHtml += '<div class=\"input-group\">';\n                            successHtml += '<input type=\"text\" class=\"form-control font-monospace text-center ph-code-input\" ';\n                            successHtml += 'value=\"' + fullCode + '\" id=\"ph-gen-code-input\" readonly>';\n                            successHtml += '<button class=\"btn btn-primary\" type=\"button\" ';\n                            successHtml += 'data-action=\"copytoclipboard\" data-clipboard-target=\"#ph-gen-code-input\">';\n                            successHtml += '<i class=\"fa fa-copy\" aria-hidden=\"true\"></i> ';\n                            successHtml += config.strings.copy + '</button>';\n                            successHtml += '</div></div>';\n                        }\n\n                        successHtml += '</div>';\n\n                        $('#ph-ai-modal .modal-body').html(successHtml);\n\n                        // Reload/Close Button.\n                        const $btnReload = $('<button class=\"btn btn-success w-100 py-2 fw-bold\">' +\n                             config.strings.great + '</button>');\n                        $btnReload.on('click', function() {\n                            window.location.reload();\n                        });\n\n                        $('#ph-ai-modal .modal-footer').empty().append($btnReload);\n\n                        // Accessibility focus.\n                        setTimeout(function() {\n                            $('#ph-success-container').focus();\n                        }, 200);\n\n                    } else {\n                        Notification.alert('Error', resp.message, 'OK');\n                    }\n                }).fail(function(ex) {\n                    $btn.prop('disabled', false).text(originalText).removeAttr('aria-busy');\n                    Notification.exception(ex);\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","Notification","Ajax","init","config","appendTo","on","e","preventDefault","modalEl","document","getElementById","bootstrap","Modal","getOrCreateInstance","show","modal","isChecked","this","is","prop","trigger","count","length","$btn","removeClass","removeAttr","btnText","strings","delete_n_items","replace","html","addClass","attr","delete_selected","confirm","confirm_title","confirm_bulk","yes","cancel","submit","name","xp","img","isImg","descTarget","descHtml","text","$descEl","trim","no_desc","$imgCont","empty","append","src","alt","slideDown","slideUp","targetUrl","msg","window","location","href","click","theme","val","alert","err_theme","originalText","ai_creating","request","methodname","args","instanceid","courseid","parseInt","amount","create_drop","drop_location","drop_max","drop_time","call","done","resp","success","one","reload","success_title","successHtml","items","created_items","item_name","push","itemsList","join","created_count","warning_msg","info_msg","drop_code","fullCode","copy","$btnReload","great","setTimeout","focus","message","fail","ex","exception"],"mappings":"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"}