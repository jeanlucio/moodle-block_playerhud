{"version":3,"file":"filter_collect.min.js","sources":["../src/filter_collect.js"],"sourcesContent":["/* global bootstrap */\ndefine(['jquery', 'core/notification'], function($, Notification) {\n\n    /**\n     * Manipula o estado visual do modo Cartão (Card).\n     *\n     * @param {Object} trigger O elemento jQuery clicado.\n     * @param {Object} card O elemento jQuery do cartão pai.\n     * @param {boolean} hasTimer Se existe cooldown ativo.\n     * @param {boolean} isLimit Se o limite de coleta foi atingido.\n     * @param {Object} resp A resposta do servidor.\n     * @param {Object} strings As strings de idioma.\n     * @param {string} originalHtml O HTML original do botão.\n     */\n    var handleCardMode = function(trigger, card, hasTimer, isLimit, resp, strings, originalHtml) {\n        if (hasTimer) {\n            trigger.removeClass('btn-primary ph-action-collect').removeAttr('href');\n            var tHtml = '⏳ <span class=\"ph-timer\" data-deadline=\"' +\n                resp.cooldown_deadline + '\">...</span>';\n            var tBtn = $('<div class=\"btn btn-light btn-sm w-100 text-muted\" tabindex=\"0\">' +\n                tHtml + '</div>');\n            trigger.replaceWith(tBtn);\n            tBtn.focus();\n        } else if (isLimit) {\n            trigger.removeClass('btn-primary ph-action-collect')\n                .addClass('btn-success disabled')\n                .css('cursor', 'default').removeAttr('href')\n                .html('<i class=\"fa fa-check\"></i> ' + strings.collected);\n            // Foca na imagem (trigger de detalhes) pois o botão morreu.\n            card.find('.ph-item-details-trigger').focus();\n        } else {\n            // Sucesso Rápido.\n            trigger.removeClass('btn-primary disabled').addClass('btn-success')\n                .html('<i class=\"fa fa-check\"></i> ' + strings.collected).css('width', '');\n            setTimeout(function() {\n                trigger.removeClass('btn-success').addClass('btn-primary')\n                    .html(originalHtml);\n                trigger.focus();\n            }, 1500);\n        }\n    };\n\n    /**\n     * Manipula o estado visual dos modos Texto e Imagem.\n     *\n     * @param {Object} trigger O elemento jQuery clicado.\n     * @param {string} mode O modo de exibição ('text' ou 'image').\n     * @param {boolean} hasTimer Se existe cooldown ativo.\n     * @param {boolean} isLimit Se o limite de coleta foi atingido.\n     * @param {Object} resp A resposta do servidor.\n     */\n    var handleTextImageMode = function(trigger, mode, hasTimer, isLimit, resp) {\n        // Se entrou em cooldown ou limite, transformamos em \"Visualizador de Detalhes\".\n        if (hasTimer || isLimit) {\n            // Remove href e classes de ação.\n            trigger.removeAttr('href').removeClass('ph-action-collect');\n            trigger.addClass('ph-item-details-trigger'); // Agora abre modal!\n            trigger.css('opacity', '1').css('pointer-events', 'auto').css('cursor', 'pointer');\n\n            if (mode === 'text') {\n                if (isLimit) {\n                    trigger.addClass('text-success')\n                        .html('<i class=\"fa fa-check\"></i> ' + trigger.text());\n                } else {\n                    // Cooldown Texto: Nome + Timer.\n                    trigger.addClass('text-muted')\n                        .html('⏳ ' + trigger.text() +\n                        ' <small class=\"ph-timer\" data-deadline=\"' +\n                        resp.cooldown_deadline + '\">...</small>');\n                }\n            } else {\n                // Image Mode.\n                if (isLimit) {\n                    // Adiciona badge de check.\n                    trigger.css('position', 'relative');\n                    trigger.append('<span class=\"badge bg-success rounded-circle\" ' +\n                        'style=\"position:absolute; bottom:-5px; right:-5px; font-size:0.6rem;\">' +\n                        '<i class=\"fa fa-check\"></i></span>');\n                    trigger.find('img, span').css('filter', 'grayscale(100%)').css('opacity', '0.6');\n                } else {\n                    // Adiciona timer embaixo.\n                    trigger.css('position', 'relative');\n                    trigger.find('img, span').css('opacity', '0.6');\n                    // Quebrando a linha longa para passar no max-len (132 chars)\n                    var badgeStyle = 'position:absolute; bottom:-10px; left:50%; ' +\n                                     'transform:translateX(-50%); font-size:0.6rem;';\n                    trigger.append('<div class=\"ph-timer badge bg-light text-dark border shadow-sm\" ' +\n                        'style=\"' + badgeStyle + '\" ' +\n                        'data-deadline=\"' + resp.cooldown_deadline + '\">...</div>');\n                }\n            }\n        } else {\n            // Coleta rápida (sem cooldown): Feedback visual breve.\n            trigger.css('opacity', '1').css('pointer-events', 'auto');\n            // Piscar verde.\n            var oldColor = trigger.css('color');\n            trigger.css('color', '#28a745');\n            setTimeout(function() {\n                trigger.css('color', oldColor);\n            }, 1000);\n        }\n    };\n\n    /**\n     * Restores the button state in case of error.\n     *\n     * @param {Object} btn jQuery object of the button.\n     * @param {string} html Original HTML content.\n     * @param {string} mode The display mode.\n     * @param {string} width Original width.\n     */\n    var restaurar = function(btn, html, mode, width) {\n        btn.html(html).removeClass('disabled');\n        if (mode === 'card') {\n            btn.css('width', width);\n        } else {\n            btn.css('opacity', '1').css('pointer-events', 'auto');\n        }\n    };\n\n    /**\n     * Updates the HUD widget progress bar.\n     *\n     * @param {Object} data Game data.\n     */\n    var updateHud = function(data) {\n        var widget = $('.playerhud-widget-container');\n        if (widget.length) {\n            widget.find('.progress-bar').css('width', data.progress + '%');\n        }\n    };\n\n    return {\n        init: function(strings) {\n\n            var $modal = $('#phItemModalFilter');\n            if ($modal.length) {\n                $modal.appendTo('body');\n            }\n\n            // 1. Modal de Detalhes (Unificado para Card, Texto e Imagem).\n            $('body').on('click keydown', '.ph-item-details-trigger', function(e) {\n                if (e.type === 'keydown' && e.key !== 'Enter' && e.key !== ' ') {\n                    return;\n                }\n                e.preventDefault();\n\n                var trigger = $(this);\n                // Dados podem estar no próprio elemento (texto/imagem) ou num pai (card).\n                var container = trigger.closest('.playerhud-item-card');\n                if (container.length === 0) {\n                    container = trigger; // Caso Texto/Imagem.\n                }\n\n                var name = container.attr('data-name');\n                var descB64 = container.attr('data-desc-b64');\n                var img = container.attr('data-image');\n                var isImg = container.attr('data-isimage');\n\n                $('#phModalTitleF, #phModalNameF').text(name);\n\n                var descHtml = '';\n                try {\n                    descHtml = decodeURIComponent(escape(window.atob(descB64)));\n                } catch (err) {\n                    descHtml = '...';\n                }\n                $('#phModalDescF').html(descHtml);\n\n                var imgCont = $('#phModalImageContainerF');\n                imgCont.empty();\n                if (isImg == '1') {\n                    imgCont.append($('<img>', {src: img, style: 'max-width:80px;'}));\n                } else {\n                    imgCont.append($('<span>', {style: 'font-size:50px;', text: img}));\n                }\n\n                var modalEl = document.getElementById('phItemModalFilter');\n                if (modalEl) {\n                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {\n                        bootstrap.Modal.getOrCreateInstance(modalEl).show();\n                    } else {\n                        $(modalEl).modal('show');\n                    }\n                }\n            });\n\n            // 2. Coleta.\n            $('body').on('click', '.ph-action-collect', function(e) {\n                e.preventDefault();\n                var trigger = $(this);\n                var mode = trigger.attr('data-mode') || 'card';\n\n                if (trigger.hasClass('disabled') || trigger.attr('disabled')) {\n                    return;\n                }\n\n                // Feedback de \"Carregando\" varia por modo.\n                var originalHtml = trigger.html();\n                var originalWidth = trigger.css('width');\n\n                if (mode === 'card') {\n                    trigger.css('width', trigger.outerWidth() + 'px');\n                    trigger.html('<i class=\"fa fa-spinner fa-spin\"></i>').addClass('disabled');\n                } else {\n                    // Texto/Imagem: Efeito de opacidade para não pular layout.\n                    trigger.css('opacity', '0.5').css('pointer-events', 'none');\n                }\n\n                var url = trigger.attr('href');\n                var ajaxUrl = url + (url.indexOf('?') === -1 ? '?' : '&') + 'ajax=1';\n\n                $.ajax({\n                    url: ajaxUrl,\n                    method: 'GET',\n                    dataType: 'json',\n                    success: function(resp) {\n                        if (resp.success) {\n                            // Atualiza Badge do Card (se existir).\n                            var card = trigger.closest('.playerhud-item-card');\n                            if (card.length) {\n                                var badge = card.find('.ph-badge-count');\n                                var currentCount = parseInt(badge.text().replace('x', ''), 10) || 0;\n                                badge.text('x' + (currentCount + 1)).show();\n                            }\n\n                            // Variáveis de estado.\n                            var hasTimer = (resp.cooldown_deadline && resp.cooldown_deadline > 0);\n                            var isLimit = resp.limit_reached;\n\n                            // Delegação para funções auxiliares para evitar aninhamento profundo (max-depth).\n                            if (mode === 'text' || mode === 'image') {\n                                handleTextImageMode(trigger, mode, hasTimer, isLimit, resp);\n                            } else {\n                                handleCardMode(trigger, card, hasTimer, isLimit, resp, strings, originalHtml);\n                            }\n\n                            if (resp.game_data) {\n                                updateHud(resp.game_data);\n                            }\n\n                        } else {\n                            restaurar(trigger, originalHtml, mode, originalWidth);\n                            Notification.alert('Ops', resp.message, 'OK');\n                        }\n                    },\n                    error: function() {\n                        restaurar(trigger, originalHtml, mode, originalWidth);\n                        Notification.alert('Erro', strings.error, 'OK');\n                    }\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","Notification","restaurar","btn","html","mode","width","removeClass","css","init","strings","$modal","length","appendTo","on","e","type","key","preventDefault","trigger","this","container","closest","name","attr","descB64","img","isImg","text","descHtml","decodeURIComponent","escape","window","atob","err","imgCont","empty","append","src","style","modalEl","document","getElementById","bootstrap","Modal","getOrCreateInstance","show","modal","hasClass","originalHtml","originalWidth","outerWidth","addClass","url","ajaxUrl","indexOf","ajax","method","dataType","success","resp","card","badge","find","currentCount","parseInt","replace","hasTimer","cooldown_deadline","isLimit","limit_reached","removeAttr","oldColor","setTimeout","handleTextImageMode","tHtml","tBtn","replaceWith","focus","collected","handleCardMode","game_data","data","widget","progress","alert","message","error"],"mappings":"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"}