define("block_playerhud/filter_collect",["exports","jquery","core/notification","core/ajax","core/str"],(function(_exports,_jquery,_notification,_ajax,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Collect items via Filter Shortcodes.
   *
   * @module     block_playerhud/filter_collect
   * @copyright  2026 Jean L√∫cio
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_notification=_interopRequireDefault(_notification),_ajax=_interopRequireDefault(_ajax),_str=_interopRequireDefault(_str);let appStrings={};const updateStash=itemData=>{(0,_jquery.default)(".ph-sidebar-stash, .ph-widget-stash").each((function(){const stash=(0,_jquery.default)(this);stash.closest(".ph-stash-wrapper").removeClass("d-none").show(),stash.find(".text-muted, span.small").remove(),stash.children().filter(((i,el)=>(0,_jquery.default)(el).attr("data-name")===itemData.name)).remove();let contentHtml="";contentHtml="1"===String(itemData.isimage)?'<img src="'.concat(itemData.image,'" alt="" class="ph-mini-item-img">'):'<span class="ph-mini-emoji" aria-hidden="true">'.concat(itemData.image,"</span>");const newItem=(0,_jquery.default)("<div>",{class:"ph-mini-item ph-item-trigger border bg-white rounded d-flex align-items-center justify-content-center overflow-hidden position-relative shadow-sm",role:"button",tabindex:"0","data-name":itemData.name,"data-xp":itemData.xp,"data-image":itemData.image,"data-isimage":itemData.isimage,"data-date":itemData.date,"data-timestamp":itemData.timestamp||0,title:itemData.name,"aria-label":itemData.name});newItem.append('<div class="d-none ph-item-description-content">'.concat(itemData.description||"","</div>")),newItem.append(contentHtml),newItem.hide().prependTo(stash).fadeIn();const limit=stash.hasClass("ph-widget-stash")?14:6;stash.children(".ph-mini-item").length>limit&&stash.children(".ph-mini-item").last().remove()}))},updateHud=(data,itemData)=>{(0,_jquery.default)(".playerhud-widget-container, .block_playerhud_sidebar").each((function(){const container=(0,_jquery.default)(this),tierRegex=/(^|\s)ph-lvl-tier-\S+/g,removeTierClasses=(idx,className)=>(className.match(tierRegex)||[]).join(" ");container.hasClass("playerhud-widget-container")&&container.removeClass(removeTierClasses).addClass(data.level_class),container.find(".ph-sidebar-grid, .progress-bar, .badge").each((function(){(0,_jquery.default)(this).removeClass(removeTierClasses).addClass(data.level_class)}));container.find(".progress-bar").css("width","".concat(data.progress,"%")).attr("aria-valuenow",data.progress);const levelBadge=container.find(".badge").filter((function(){return(0,_jquery.default)(this).attr("class").match(/ph-lvl-tier-/)}));if(levelBadge.length){const labelText=appStrings.level||"Level";let lvlString="".concat(data.level);data.max_levels>0&&(lvlString+="/".concat(data.max_levels)),levelBadge.text("".concat(labelText," ").concat(lvlString))}container.find("span, div, strong").each((function(){const el=(0,_jquery.default)(this);if(0===el.children().length&&el.text().indexOf("XP")>-1){let xpString="".concat(data.currentxp);data.xp_target>0&&(xpString+=" / ".concat(data.xp_target)),xpString+=" XP",data.is_win&&(xpString+=" üèÜ"),el.text(xpString)}}))})),itemData&&updateStash(itemData)},toggleLoading=function(trigger,isLoading){let originalHtml=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const mode=trigger.attr("data-mode")||"card";isLoading?(trigger.addClass("disabled").attr("aria-disabled","true"),"card"===mode?(trigger.css("width",trigger.outerWidth()+"px"),trigger.html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>')):trigger.addClass("ph-opacity-50").css("pointer-events","none")):(trigger.removeClass("disabled").removeAttr("aria-disabled"),"card"===mode?(trigger.css("width",""),trigger.html(originalHtml)):trigger.removeClass("ph-opacity-50").css("pointer-events","auto"))},handleCollectionSuccess=(trigger,resp,originalHtml,strings)=>{const mode=trigger.attr("data-mode")||"card",hasTimer=resp.cooldown_deadline&&resp.cooldown_deadline>0,isLimit=resp.limit_reached;if(resp.item_data){const card=trigger.closest(".playerhud-item-card");if(card.length){const badge=card.find(".ph-badge-count");if("1"!==card.attr("data-unique")){const currentCount=parseInt(badge.text().replace("x",""),10)||0;badge.text("x"+(currentCount+1)).removeClass("d-none").show()}card.attr("data-date",resp.item_data.date),card.attr("data-timestamp",resp.item_data.timestamp),card.attr("data-xp",resp.item_data.xp)}"image"===mode&&trigger.closest(".ph-drop-image-container").attr({"data-date":resp.item_data.date,"data-timestamp":resp.item_data.timestamp,"data-xp":resp.item_data.xp})}"text"===mode||"image"===mode?((trigger,mode,hasTimer,isLimit,resp)=>{if(trigger.removeClass("disabled ph-opacity-50").removeAttr("aria-disabled").css("pointer-events","auto"),hasTimer||isLimit)if("text"===mode)trigger.removeAttr("href").removeClass("ph-action-collect").addClass("ph-item-details-trigger"),trigger.css({cursor:"pointer","pointer-events":"auto",opacity:"1"}),isLimit?trigger.addClass("text-success fw-bold").html('<i class="fa fa-check" aria-hidden="true"></i> '.concat(trigger.text())):trigger.addClass("ph-text-dimmed").html('<span aria-hidden="true">‚è≥</span> '.concat(trigger.text()," ")+'<small class="ph-timer" data-deadline="'.concat(resp.cooldown_deadline,'">...</small>'));else{const container=trigger.closest(".ph-drop-image-container"),imgWrapper=container.find("> div").first();trigger.remove(),container.addClass("ph-item-details-trigger ph-cursor-pointer").attr({tabindex:"0",role:"button"}),isLimit?(imgWrapper.addClass("ph-state-grayscale"),container.append('<span class="badge bg-success rounded-circle ph-badge-bottom-right"><i class="fa fa-check" aria-hidden="true"></i></span>')):(imgWrapper.addClass("ph-state-dimmed"),container.append('<div class="ph-timer badge bg-light text-dark border shadow-sm ph-badge-bottom-center"\n                    data-deadline="'.concat(resp.cooldown_deadline,'" data-no-label="1">...</div>')))}else if("text"===mode){const oldColor=trigger.css("color");trigger.css("color","#198754"),setTimeout((()=>trigger.css("color",oldColor)),1e3)}})(trigger,mode,hasTimer,isLimit,resp):((trigger,hasTimer,isLimit,resp,originalHtml)=>{if(hasTimer){trigger.removeClass("btn-primary ph-action-collect").removeAttr("href");const tHtml='‚è≥ <span class="ph-timer" data-deadline="'.concat(resp.cooldown_deadline,'">...</span>'),tBtn=(0,_jquery.default)('<div class="btn btn-light btn-sm w-100 ph-text-dimmed" tabindex="0">'.concat(tHtml,"</div>"));trigger.replaceWith(tBtn),tBtn.focus()}else if(isLimit){const collectedText=appStrings.collected||"Collected";trigger.removeClass("btn-primary ph-action-collect").addClass("btn-light text-success disabled border-success").css("cursor","default").removeAttr("href").html('<i class="fa fa-check" aria-hidden="true"></i> '.concat(collectedText)),trigger.closest(".playerhud-item-card").find(".ph-item-details-trigger").focus()}else{const collectedText=appStrings.collected||"Collected";trigger.removeClass("btn-primary disabled").addClass("btn-success").html('<i class="fa fa-check" aria-hidden="true"></i> '.concat(collectedText)).css("width",""),setTimeout((()=>{trigger.removeClass("btn-success").addClass("btn-primary").html(originalHtml),trigger.removeAttr("aria-disabled"),trigger.focus()}),1500)}})(trigger,hasTimer,isLimit,resp,originalHtml),resp.game_data&&updateHud(resp.game_data,resp.item_data)};_exports.init=config=>{appStrings=config.strings||{};const $filterModal=(0,_jquery.default)("#phItemModalFilter");$filterModal.length&&$filterModal.appendTo("body"),(0,_jquery.default)("body").on("click",".js-disable-hud",(function(e){e.preventDefault();const url=(0,_jquery.default)(this).attr("href"),msg=(0,_jquery.default)(this).attr("data-confirm-msg");_notification.default.confirm(appStrings.confirm_title,msg,appStrings.yes,appStrings.cancel,(()=>{window.location.href=url}))})),(0,_jquery.default)("body").on("click keydown",".ph-item-details-trigger",(function(e){if("keydown"===e.type&&"Enter"!==e.key&&" "!==e.key)return;e.preventDefault();const trigger=(0,_jquery.default)(this);let container=trigger.closest(".playerhud-item-card, .ph-drop-image-container, .ph-mini-item");container.length||(container=trigger);const data={name:container.attr("data-name"),descB64:container.attr("data-desc-b64"),descDirect:container.find(".ph-item-description-content").html(),img:container.attr("data-image"),isImg:container.attr("data-isimage"),xp:container.attr("data-xp"),date:container.attr("data-date"),timestamp:container.attr("data-timestamp")},modalEls=(()=>{let root=(0,_jquery.default)("#phItemModalView"),suffix="View";return root.length||(root=(0,_jquery.default)("#phItemModalFilter"),suffix="F"),{root:root,title:(0,_jquery.default)("#phModalTitle".concat(suffix)),name:(0,_jquery.default)("#phModalName".concat(suffix)),desc:(0,_jquery.default)("#phModalDesc".concat(suffix)),imgContainer:(0,_jquery.default)("#phModalImageContainer".concat(suffix)),xp:(0,_jquery.default)("#phModalXP".concat(suffix)),countBadge:(0,_jquery.default)("#phModalCountBadge".concat(suffix)),date:(0,_jquery.default)("#phModalDate".concat(suffix)),dateContainer:(0,_jquery.default)("#phModalDateContainer".concat(suffix))}})();if(!modalEls.root.length)return;if(modalEls.title.text(data.name),modalEls.name.text(data.name),data.xp&&"0"!==data.xp){if(-1===String(data.xp).indexOf("???")){const xpText=!isNaN(parseFloat(data.xp))&&isFinite(data.xp)?"".concat(data.xp," XP"):data.xp;modalEls.xp.text(xpText).removeClass("d-none").show(),modalEls.xp.removeClass("ph-bg-teal bg-info text-dark").addClass("bg-primary text-white")}else modalEls.xp.hide()}else modalEls.xp.hide();modalEls.countBadge.length&&modalEls.countBadge.hide();let descHtml="...";data.descDirect?descHtml=data.descDirect:data.descB64&&(descHtml=(str=>{try{const binString=window.atob(str),bytes=Uint8Array.from(binString,(m=>m.codePointAt(0)));return(new TextDecoder).decode(bytes)}catch(e){return""}})(data.descB64)),modalEls.desc.html(descHtml);let formattedDate=data.date;if(data.timestamp&&data.timestamp>0){const lang=(0,_jquery.default)("html").attr("lang").replace("_","-")||"en";try{formattedDate=new Date(1e3*parseInt(data.timestamp)).toLocaleDateString(lang,{day:"2-digit",month:"2-digit",year:"2-digit"})}catch(err){}}if(formattedDate){const prefix=appStrings.last_collected?"".concat(appStrings.last_collected," "):"";"phItemModalView"===modalEls.root.attr("id")?(modalEls.date.find("span").text(prefix+formattedDate),modalEls.date.show()):(modalEls.date.text(prefix+formattedDate),modalEls.dateContainer&&modalEls.dateContainer.removeClass("d-none"))}else"phItemModalView"===modalEls.root.attr("id")?modalEls.date.hide():modalEls.dateContainer&&modalEls.dateContainer.addClass("d-none");modalEls.imgContainer.empty(),"1"===String(data.isImg)?modalEls.imgContainer.append((0,_jquery.default)("<img>",{src:data.img,class:"ph-modal-img",alt:""})):modalEls.imgContainer.append((0,_jquery.default)("<span>",{class:"ph-modal-emoji","aria-hidden":"true",text:data.img}));const modalEl=modalEls.root[0];"undefined"!=typeof bootstrap&&bootstrap.Modal?bootstrap.Modal.getOrCreateInstance(modalEl).show():modalEls.root.modal("show")})),(0,_jquery.default)("body").on("click",".ph-action-collect",(function(e){e.preventDefault();const trigger=(0,_jquery.default)(this);if(trigger.hasClass("disabled")||trigger.attr("aria-disabled"))return;const originalHtml=trigger.html();toggleLoading(trigger,!0);const href=trigger.attr("href");if(!href)return void toggleLoading(trigger,!1,originalHtml);const urlObj=new URL(href,window.location.href),params={instanceid:parseInt(urlObj.searchParams.get("instanceid")),dropid:parseInt(urlObj.searchParams.get("dropid")),courseid:parseInt(urlObj.searchParams.get("courseid"))};isNaN(params.instanceid)||isNaN(params.dropid)||isNaN(params.courseid)?toggleLoading(trigger,!1,originalHtml):_ajax.default.call([{methodname:"block_playerhud_collect_item",args:params}])[0].then((resp=>{if(!resp.success)return toggleLoading(trigger,!1,originalHtml),_str.default.get_strings([{key:"error",component:"core"},{key:"ok",component:"core"}]).then((strs=>_notification.default.alert(strs[0],resp.message,strs[1])));handleCollectionSuccess(trigger,resp,originalHtml)})).catch((ex=>{toggleLoading(trigger,!1,originalHtml),_notification.default.exception(ex)}))}))}}));

//# sourceMappingURL=filter_collect.min.js.map